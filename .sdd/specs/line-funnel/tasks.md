# Tasks – Cursorvers LINE Funnel (Current Iteration)

基準ドキュメント: `.sdd/specs/line-funnel/design.md`。以下タスクは設計の各セクションに対応し、実装完了後は `/sdd-implement` に進む。

| # | Title / Objective | Owner | Priority | Design Reference | Key Files / Modules | Definition of Done & Tests | Dependencies | Parallel Ready |
|---|------------------|-------|----------|------------------|---------------------|----------------------------|--------------|----------------|
| T1 | Requirements traceability & feature flag gating; ensure every open acceptance criterion maps to a task and is protected behind documented flags | Product/Tech Lead | P0 | [Design §Requirements Alignment](design.md#requirements-alignment) | `.sdd/specs/archives/2025-11-01-line-funnel/requirements.md`<br>`README.md`<br>`docs/ENV_VAR_SETUP.md` | Traceability matrix updated; feature flag matrix captured; toggle tests executed via `npm test -- feature-flags` (or equivalent) with both flag states covered in CI | – | No |
| T2 | Finalise Supabase schemas, constraints, and RPCs for telemetry tables | Data/Infra | P0 | [Design §Data Models & API Contracts](design.md#data-models--api-contracts) | `database/migrations/**`<br>`database/functions/line_conversion_kpi.sql`<br>`tests/node/supabase-schema.test.mjs` | Forward and rollback migrations run cleanly on staging; schema/RPC unit tests pass; unique/idempotency constraints verified via test fixtures | T1 | Partial (schema review can run in parallel with T3 after requirements trace is set) |
| T3 | Harden Front Door relay payload validation, hashing, and idempotency cache with structured logging | Edge Backend | P0 | [Design §Architecture Overview](design.md#architecture-overview)<br>[Design §Data Flow Narrative](design.md#data-flow-narrative)<br>[Design §Front Door Dispatch Payloads](design.md#front-door-dispatch-payloads) | `functions/relay/index.ts`<br>`functions/relay/index.test.ts`<br>`functions/relay/kv.ts` | Deno unit tests cover HMAC, dedupe, and redaction paths; structured logs reviewed; deployment plan documented | T1 | Yes (after T1) |
| T4 | Align Plan JSON + degraded variant with orchestration and ensure switch logic adheres to feature flags | DevOps/Plan | P0 | [Design §Data Models → Plan JSON / PlanDelta](design.md#plan-json--plandelta-contracts)<br>[Design §Architecture Overview](design.md#architecture-overview)<br>[Design §Deployment & Operational Considerations](design.md#deployment--operational-considerations) | `orchestration/plan/production/current_plan.json`<br>`orchestration/plan/production/degraded_plan.json`<br>`docs/alerts/*`<br>`scripts/plan/validate-plan.ts` | Plan/json validated via `workflow_dispatch plan-validate`; degraded switch tested with simulated `degraded.flag`; CODEOWNERS approvals captured | T1, T2, T3 | No |
| T5 | Implement LINE inbound workflow with Supabase + Sheets dual-write, notifications, and plan branching | DevOps | P0 | [Design §Data Flow Narrative → LINE inbound](design.md#data-flow-narrative)<br>[Design §Google Sheets (transitional ledger)](design.md#google-sheets-transitional-ledger) | `.github/workflows/line-event.yml`<br>`scripts/supabase/upsert-progress-event.js`<br>`scripts/sheets/upsert-line-member.js`<br>`logs/progress/` | `act` integration tests pass (normal + degraded modes); Supabase & Sheets entries validated; notifications delivered via `scripts/notify.js`; degraded mode surfaces reason + ICS instructions; JSON log committed | T2, T3, T4 | No |
| T6 | Complete Manus progress workflow: Supabase persistence, PlanDelta reconciliation, controlled Manus retries | DevOps | P0 | [Design §Data Flow Narrative → Manus progress](design.md#data-flow-narrative)<br>[Design §Plan JSON / PlanDelta](design.md#plan-json--plandelta-contracts) | `.github/workflows/manus-progress.yml`<br>`scripts/supabase/upsert-progress-event.js`<br>`scripts/manus/retry-task.ts`<br>`logs/progress/` | Workflow integration tests (mock Manus) cover retry/idempotency paths; Supabase rows validated; Step Summary reports reconciliation outcome | T2, T3, T4 | Partial (testing can run in parallel with T5 once shared libs stable) |
| T7 | Build economic circuit breaker ingesting vendor cost feeds and toggling degraded mode guardrails | Finance/DevOps | P0 | [Design §Data Flow Narrative → Budget guardrail](design.md#data-flow-narrative)<br>[Design §Risks & Mitigations](design.md#risks--mitigations) | `.github/workflows/economic-circuit-breaker.yml`<br>`scripts/budget/**`<br>`logs/budget/`<br>`BUDGET.yml` | Vendor feed parser tested (CSV/API); warn/trip branches exercise via `npm test -- budget`; degraded flag toggled and logged; notifications issued | T2, T4 | Yes (after T2, T4) |
| T8 | Deliver KPI reporting workflow backed by Supabase RPC and GitHub Step Summary outputs | Data/Marketing Ops | P1 | [Design §Data Flow Narrative → KPI reporting](design.md#data-flow-narrative)<br>[Design §Data Models & API Contracts](design.md#data-models--api-contracts) | `.github/workflows/weekly-kpi-report.yml`<br>`scripts/kpi/generate-kpi-report.js`<br>`tests/node/kpi-report.test.mjs`<br>`logs/kpi/` (artifact) | RPC returns seeded fixture results; workflow writes weekly snapshot JSON/Markdown, Step Summary flags goal attainment, downstream notifications (Discussions/Slack) validated | T2 | Yes (parallel with T7 once schema finalised) |
| T9 | Harden operational tooling: secrets verification, replay scripts, and onboarding docs | Ops | P1 | [Design §Architecture Overview → Operational tooling](design.md#architecture-overview)<br>[Design §Deployment & Operational Considerations](design.md#deployment--operational-considerations) | `scripts/verify-secrets.sh`<br>`scripts/replay-progress-event.ts`<br>`docs/ENV_VAR_SETUP.md`<br>`docs/RUNBOOK.md` | Secrets checklist script enforced in CI; replay script documented/tested against fixtures; runbooks updated for onboarding and degraded drills | T5, T6, T7 | Partial |
| T10 | Establish cross-runtime CI coverage (Deno/Node/Python) with enforced thresholds | QA/Dev | P1 | [Design §Testing Strategy](design.md#testing-strategy) | `.github/workflows/deno-tests.yml`<br>`.github/workflows/node-tests.yml`<br>`.github/workflows/python-tests.yml`<br>`package.json`<br>`requirements-dev.txt` | CI pipelines pass; coverage thresholds met (>80% Node, >70% Deno); failure gates documented | T5, T6, T7 | Yes |
| T11 | Standardise observability: JSON schema validation, Step Summary metrics, Datadog/OTLP stubs | DevOps | P1 | [Design §Testing Strategy → Observability & Regression Guards](design.md#testing-strategy)<br>[Design §Deployment & Operational Considerations → Observability](design.md#deployment--operational-considerations) | `scripts/notify.js`<br>`logs/**/*.json`<br>`scripts/metrics/report-step-summary.ts`<br>`docs/RUNBOOK.md` | AJV schemas enforced in workflows; Step Summary includes Supabase status/retry/cost; runbook updated with audit review procedure | T5, T6, T7, T10 | No |
| T12 | Automate Supabase ↔ Sheets ledger reconciliation with alerting on drift | Data/Infra | P1 | [Design §Google Sheets (transitional ledger)](design.md#google-sheets-transitional-ledger)<br>[Design §Risks & Mitigations](design.md#risks--mitigations) | `scripts/reconcile-ledgers.ts`<br>`tests/node/reconcile-ledgers.test.mjs`<br>`docs/DATA_MODEL.md` | Reconciliation script emits diff report + optional Slack alert; scheduled/manual run documented; unit tests cover drift scenarios | T5, T8 | Yes |
| T13 | Enforce security & privacy guardrails (sanitisation lint rules, nightly identifier scans) | Security/Dev | P1 | [Design §Risks & Mitigations](design.md#risks--mitigations) | `scripts/lint/sanitize-guardrails.ts`<br>`.github/workflows/security-scan.yml`<br>`docs/SECURITY.md` | Lint rule blocks unhashed identifiers; nightly scan job configured; documentation updated with remediation steps | T5, T6 | Yes |
| T14 | Drive stakeholder decision log (KPI owner, Sheets strategy, plan approvals, degraded messaging) | Product/Ops | P2 | [Design §Outstanding Questions & Assumptions](design.md#outstanding-questions--assumptions) | `docs/CURRENT_PROGRESS.md`<br>`.sdd/steering/*.md`<br>`issues/*` | Decision log updated with owners + due dates; blocking decisions escalated; steering cadence recorded | Parallel (inform all phases) | Yes |

### Sequencing & Parallelism
- **Phase 0 – Foundations:** T1 → T2 establish requirements traceability and database schemas. T3 can start once T1 locks traceability.
- **Phase 1 – Orchestration Core:** T4 depends on earlier groundwork; T5 & T6 follow sequentially because they share libraries; T7 can run in parallel with T5/T6 after plan artifacts stabilise.
- **Phase 2 – Reporting & Ops Hardening:** T8 executes once schema (T2) is live; T9, T10, and T11 leverage completed workflows and can run concurrently with careful coordination.
- **Phase 3 – Governance & Safeguards:** T12 and T13 begin after core data flows (T5–T8); T14 remains ongoing to unblock prior phases.

### Phase 2 Kickoff – Immediate Actions
- **T8 (Data/Marketing Ops)**  
  - Validate Supabase staging credentials and confirm `line_conversion_kpi` RPC signature。  
  - Decide public channel（GitHub Discussions / Slack）へのレポート配信方式。  
  - Dry-run `weekly-kpi-report.yml` with sanitized data before本番スケジュール運用。

- **T9 (Ops)**  
  - 実運用で必要な Secrets チェック／リプレイスクリプトの自動テストを整備。  
  - `docs/ENV_VAR_SETUP.md` と dev-infra スクリプトを最新化し、オンボーディング手順を確立。

- **T10 (QA/Dev)**  
  - Deno/Node/Python CI ワークフローを有効化し、`npm test` で node --test が走るよう統一。  
  - 必要に応じてカバレッジ閾値や Step Summary を導入し、失敗時のフィードバックを明確化。

### Blockers & Risks
- Vendor billing API or CSV access delays could stall T7; prepare mock feeds and confirm Finance contacts.
- Missing `contents:write` scope on GitHub tokens will block Git-based logging (T5–T7); secure PAT fallback before production dry-runs.
- Supabase production project allocation remains pending; T2/T5/T6 require endpoint decisions—track under T14.
- Degraded ICS messaging assets and contact rotation must be finalised prior to closing T4/T7; escalate via stakeholder log.
- Security scans (T13) rely on access to repositories storing historical logs; ensure permissions granted to automation bot.
