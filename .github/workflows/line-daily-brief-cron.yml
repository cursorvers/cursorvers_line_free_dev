# .github/workflows/line-daily-brief-cron.yml
# é€±2å› LINE Daily Brief ã‚’é…ä¿¡ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆæœˆæ›œ=Belief, æœ¨æ›œ=noteè¨˜äº‹ï¼‰

name: LINE Daily Brief

on:
  schedule:
    # æœˆæ›œ JST 07:00 (UTC 22:00 æ—¥æ›œ) â€” Obsidian Beliefã‚«ãƒ¼ãƒ‰
    - cron: '0 22 * * 0'
    # æœ¨æ›œ JST 07:00 (UTC 22:00 æ°´æ›œ) â€” noteè¨˜äº‹ã‚¬ãƒãƒŠãƒ³ã‚¹ã‚«ãƒ¼ãƒ‰
    - cron: '0 22 * * 3'
  workflow_dispatch:
    inputs:
      source_type:
        description: 'Card source type (belief or note). Leave empty for auto.'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - belief
          - note

concurrency:
  group: line-daily-brief
  cancel-in-progress: true

jobs:
  send-daily-brief:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Setup log directory
        run: |
          mkdir -p workflow-logs
          echo "LOG_FILE=workflow-logs/line-daily-brief-$(date -u +%Y%m%d_%H%M%S).log" >> $GITHUB_ENV

      - name: Determine source type
        id: source
        run: |
          # Manual input takes priority
          MANUAL_SOURCE="${{ github.event.inputs.source_type }}"
          if [ -n "$MANUAL_SOURCE" ]; then
            echo "type=$MANUAL_SOURCE" >> "$GITHUB_OUTPUT"
            echo "ğŸ“‹ Manual source_type: $MANUAL_SOURCE"
            exit 0
          fi

          # Schedule-based: Sunday 22:00 UTC (Mon JST) = belief, Wed 22:00 UTC (Thu JST) = note
          DOW=$(date -u +%u)  # 1=Mon ... 7=Sun
          if [ "$DOW" = "7" ]; then
            echo "type=belief" >> "$GITHUB_OUTPUT"
            echo "ğŸ“‹ Schedule source_type: belief (Monday JST)"
          elif [ "$DOW" = "3" ]; then
            echo "type=note" >> "$GITHUB_OUTPUT"
            echo "ğŸ“‹ Schedule source_type: note (Thursday JST)"
          else
            echo "type=" >> "$GITHUB_OUTPUT"
            echo "ğŸ“‹ No specific source_type (auto)"
          fi

      - name: Trigger line-daily-brief Edge Function
        env:
          SUPABASE_URL: ${{ vars.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SOURCE_TYPE: ${{ steps.source.outputs.type }}
        run: |
          exec > >(tee -a "$LOG_FILE") 2>&1
          echo "ğŸ“¤ LINE Daily Brief ã‚’é…ä¿¡ä¸­... (source_type: ${SOURCE_TYPE:-auto})"

          # Build request body
          if [ -n "$SOURCE_TYPE" ]; then
            BODY="{\"source_type\": \"${SOURCE_TYPE}\"}"
          else
            BODY="{}"
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${SUPABASE_URL}/functions/v1/line-daily-brief" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -d "$BODY")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          RESP_BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $RESP_BODY"
          echo "HTTP Code: $HTTP_CODE"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ Edge Function returned $HTTP_CODE"
            exit 1
          fi

          # no_card ã®å ´åˆã‚‚ã‚¨ãƒ©ãƒ¼ã«ã—ãªã„
          STATUS=$(echo "$RESP_BODY" | jq -r '.status // empty')
          if [ "$STATUS" = "no_card" ]; then
            echo "ğŸ“­ é…ä¿¡å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆæ­£å¸¸çµ‚äº†ï¼‰"
          elif [ "$STATUS" = "success" ]; then
            echo "âœ… LINE Daily Brief é…ä¿¡æˆåŠŸ"
          else
            echo "âš ï¸ äºˆæœŸã—ãªã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $STATUS"
          fi

      - name: Notify on failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_ADMIN_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d '{"content": "âš ï¸ **LINE Daily Brief ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¤±æ•—ã—ã¾ã—ãŸ**\nhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'
          fi

      - name: Upload workflow logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: line-daily-brief-logs-${{ github.run_number }}-${{ github.run_attempt }}
          path: workflow-logs/
          retention-days: 90
