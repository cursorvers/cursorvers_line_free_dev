# .github/workflows/discord-forum-sync.yml
# ÈÄ±1Âõû Discord Forum „Å´Êú™ÊäïÁ®ø„ÅÆ note Ë®ò‰∫ã„Çí„Çπ„É¨„ÉÉ„Éâ„Å®„Åó„Å¶ÂêåÊúü

name: Discord Forum Sync

on:
  schedule:
    # ÊØéÈÄ±Êó•Êõú JST 04:00 (UTC ÂúüÊõú 19:00)
    - cron: '0 19 * * 6'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to run (seed / import / status)'
        required: true
        default: 'import'
        type: choice
        options:
          - seed
          - import
          - status

concurrency:
  group: discord-forum-sync
  cancel-in-progress: true

jobs:
  sync-forum:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Setup log directory
        run: |
          mkdir -p workflow-logs
          echo "LOG_FILE=workflow-logs/discord-forum-sync-$(date -u +%Y%m%d_%H%M%S).log" >> $GITHUB_ENV

      - name: Run Discord Forum Library
        env:
          SUPABASE_URL: ${{ vars.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          exec > >(tee -a "$LOG_FILE") 2>&1

          ACTION="${{ github.event.inputs.action || 'import' }}"
          echo "üìö Discord Forum Sync: action=${ACTION}"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${SUPABASE_URL}/functions/v1/discord-forum-library" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -d "{\"action\": \"${ACTION}\"}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "‚ùå Edge Function returned $HTTP_CODE"
            exit 1
          fi

          OK=$(echo "$BODY" | jq -r '.ok // false')
          if [ "$OK" != "true" ]; then
            echo "‚ùå Action failed: $(echo "$BODY" | jq -r '.error // "unknown"')"
            exit 1
          fi

          echo "‚úÖ Discord Forum Sync ÂÆå‰∫Ü"
          echo "$BODY" | jq .

      - name: Notify on failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_ADMIN_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d '{"content": "‚ö†Ô∏è **Discord Forum Sync „ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÅåÂ§±Êïó„Åó„Åæ„Åó„Åü**\nhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'
          fi

      - name: Upload workflow logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: discord-forum-sync-logs-${{ github.run_number }}-${{ github.run_attempt }}
          path: workflow-logs/
          retention-days: 90
