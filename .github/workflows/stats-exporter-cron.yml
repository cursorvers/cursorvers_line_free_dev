name: Stats Exporter to Google Sheets

on:
  schedule:
    # 12ÊôÇÈñì„Åî„Å®„Å´ÂÆüË°åÔºà00:00 JST „Å® 12:00 JSTÔºâ
    - cron: '0 15,3 * * *'  # 00:00 JST (15:00 UTC) „Å® 12:00 JST (03:00 UTC)
  workflow_dispatch:  # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ

jobs:
  export-stats:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Setup log directory
        run: |
          mkdir -p workflow-logs
          echo "LOG_FILE=workflow-logs/stats-exporter-$(date -u +%Y%m%d_%H%M%S).log" >> $GITHUB_ENV

      - name: Export stats to Google Sheets
        run: |
          exec > >(tee -a "$LOG_FILE") 2>&1
          echo "üìä Exporting stats to Google Sheets..."
          
          # stats-exporter Supabase Function„ÇíÂëº„Å≥Âá∫„Åó
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ vars.SUPABASE_URL }}/functions/v1/stats-exporter?mode=full" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Stats exported successfully"
          else
            echo "‚ùå Stats export failed with status $HTTP_CODE"
            exit 1
          fi

      - name: Notify Discord on failure
        if: failure()
        run: |
          if [ -n "${{ secrets.DISCORD_ADMIN_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.DISCORD_ADMIN_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "‚ùå Stats Exporter Failed",
                  "description": "Google Sheets„Å∏„ÅÆÁµ±Ë®àÊÉÖÂ†±„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÅåÂ§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ",
                  "color": 15158332,
                  "fields": [
                    {
                      "name": "Repository",
                      "value": "'"$GITHUB_REPOSITORY"'",
                      "inline": true
                    },
                    {
                      "name": "Workflow",
                      "value": "Stats Exporter",
                      "inline": true
                    },
                    {
                      "name": "Run",
                      "value": "[View Logs]('"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"')",
                      "inline": false
                    }
                  ],
                  "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
                }]
              }'
          fi

      - name: Notify Discord on success
        if: success()
        run: |
          if [ -n "${{ secrets.DISCORD_ADMIN_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.DISCORD_ADMIN_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "‚úÖ Stats Exported",
                  "description": "Google Sheets„Å∏„ÅÆÁµ±Ë®àÊÉÖÂ†±„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ",
                  "color": 3066993,
                  "fields": [
                    {
                      "name": "Repository",
                      "value": "'"$GITHUB_REPOSITORY"'",
                      "inline": true
                    },
                    {
                      "name": "Workflow",
                      "value": "Stats Exporter",
                      "inline": true
                    }
                  ],
                  "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
                }]
              }'
          fi

      - name: Upload workflow logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stats-exporter-logs-${{ github.run_number }}-${{ github.run_attempt }}
          path: workflow-logs/
          retention-days: 90
