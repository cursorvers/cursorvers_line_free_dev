name: Deploy Supabase Edge Functions

on:
  push:
    branches:
      - main
    paths:
      - "supabase/functions/**"
      - ".github/workflows/deploy-supabase.yml"
  workflow_dispatch:

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
  DISCORD_SYSTEM_WEBHOOK: ${{ secrets.DISCORD_SYSTEM_WEBHOOK }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Setup log directory
        run: |
          mkdir -p deploy-logs
          echo "DEPLOY_LOG=deploy-logs/deploy-$(date -u +%Y%m%d_%H%M%S).log" >> $GITHUB_ENV

      # ========================================
      # Core Functions (JWT検証あり)
      # ========================================
      - name: Deploy line-webhook
        run: |
          echo "=== Deploy line-webhook ===" | tee -a "$DEPLOY_LOG"
          supabase functions deploy line-webhook --project-ref "$SUPABASE_PROJECT_ID" 2>&1 | tee -a "$DEPLOY_LOG"
        continue-on-error: true

      - name: Deploy line-daily-brief
        run: |
          echo "=== Deploy line-daily-brief ===" | tee -a "$DEPLOY_LOG"
          supabase functions deploy line-daily-brief --project-ref "$SUPABASE_PROJECT_ID" 2>&1 | tee -a "$DEPLOY_LOG"
        continue-on-error: true

      - name: Deploy stats-exporter
        run: |
          echo "=== Deploy stats-exporter ===" | tee -a "$DEPLOY_LOG"
          supabase functions deploy stats-exporter --project-ref "$SUPABASE_PROJECT_ID" 2>&1 | tee -a "$DEPLOY_LOG"
        continue-on-error: true

      - name: Deploy health-check
        run: |
          echo "=== Deploy health-check ===" | tee -a "$DEPLOY_LOG"
          supabase functions deploy health-check --project-ref "$SUPABASE_PROJECT_ID" 2>&1 | tee -a "$DEPLOY_LOG"
        continue-on-error: true

      - name: Deploy manus-audit-line-daily-brief
        run: |
          echo "=== Deploy manus-audit-line-daily-brief ===" | tee -a "$DEPLOY_LOG"
          supabase functions deploy manus-audit-line-daily-brief --project-ref "$SUPABASE_PROJECT_ID" 2>&1 | tee -a "$DEPLOY_LOG"
        continue-on-error: true

      - name: Deploy relay
        run: |
          echo "=== Deploy relay ===" | tee -a "$DEPLOY_LOG"
          supabase functions deploy relay --project-ref "$SUPABASE_PROJECT_ID" 2>&1 | tee -a "$DEPLOY_LOG"
        continue-on-error: true

      # ========================================
      # Webhook Functions (JWT検証なし)
      # 理由: 外部サービスからのリクエストを受け付けるため
      # セキュリティ: 各関数内で独自の認証・署名検証を実装
      #   - stripe-webhook: Stripe署名検証 (constructEventAsync)
      #   - line-register: LIFF経由のリクエスト
      #   - discord-bot: Discord署名検証
      #   - create-checkout-session: フロントエンドからのリクエスト
      #   - ingest-hij: API Key認証
      #   - generate-sec-brief: API Key認証
      # ========================================
      - name: Deploy stripe-webhook
        run: |
          echo "=== Deploy stripe-webhook (no-verify-jwt) ===" | tee -a "$DEPLOY_LOG"
          supabase functions deploy stripe-webhook --no-verify-jwt --project-ref "$SUPABASE_PROJECT_ID" 2>&1 | tee -a "$DEPLOY_LOG"
        continue-on-error: true

      - name: Deploy create-checkout-session
        run: |
          echo "=== Deploy create-checkout-session (no-verify-jwt) ===" | tee -a "$DEPLOY_LOG"
          supabase functions deploy create-checkout-session --no-verify-jwt --project-ref "$SUPABASE_PROJECT_ID" 2>&1 | tee -a "$DEPLOY_LOG"
        continue-on-error: true

      - name: Deploy ingest-hij
        run: |
          echo "=== Deploy ingest-hij (no-verify-jwt) ===" | tee -a "$DEPLOY_LOG"
          supabase functions deploy ingest-hij --no-verify-jwt --project-ref "$SUPABASE_PROJECT_ID" 2>&1 | tee -a "$DEPLOY_LOG"
        continue-on-error: true

      - name: Deploy generate-sec-brief
        run: |
          echo "=== Deploy generate-sec-brief (no-verify-jwt) ===" | tee -a "$DEPLOY_LOG"
          supabase functions deploy generate-sec-brief --no-verify-jwt --project-ref "$SUPABASE_PROJECT_ID" 2>&1 | tee -a "$DEPLOY_LOG"
        continue-on-error: true

      - name: Deploy line-register
        run: |
          echo "=== Deploy line-register (no-verify-jwt) ===" | tee -a "$DEPLOY_LOG"
          supabase functions deploy line-register --no-verify-jwt --project-ref "$SUPABASE_PROJECT_ID" 2>&1 | tee -a "$DEPLOY_LOG"
        continue-on-error: true

      - name: Deploy discord-bot
        run: |
          echo "=== Deploy discord-bot (no-verify-jwt) ===" | tee -a "$DEPLOY_LOG"
          supabase functions deploy discord-bot --no-verify-jwt --project-ref "$SUPABASE_PROJECT_ID" 2>&1 | tee -a "$DEPLOY_LOG"
        continue-on-error: true

      # ========================================
      # Notification
      # ========================================
      - name: Send Discord notification
        if: always()
        run: |
          STATUS="${{ job.status }}"
          TIMESTAMP=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')

          if [ "$STATUS" = "success" ]; then
            EMOJI="✅"
            COLOR="5763719"
          else
            EMOJI="⚠️"
            COLOR="16776960"
          fi

          curl -X POST "$DISCORD_SYSTEM_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"${EMOJI} Edge Functions Deploy ${STATUS}\", \"description\": \"全12関数のデプロイを実行\", \"color\": ${COLOR}, \"fields\": [{\"name\": \"Commit\", \"value\": \"${GITHUB_SHA:0:7}\", \"inline\": true}, {\"name\": \"Time\", \"value\": \"${TIMESTAMP}\", \"inline\": true}], \"url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}]}"

      # ========================================
      # Log Artifact
      # ========================================
      - name: Upload deploy logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-logs-${{ github.run_number }}-${{ github.run_attempt }}
          path: deploy-logs/
          retention-days: 90
