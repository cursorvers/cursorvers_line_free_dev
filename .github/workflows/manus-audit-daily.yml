name: Manus Audit (Daily)

on:
  schedule:
    - cron: '0 19 * * *'  # æ¯Žæ—¥04:00 JST (19:00 UTC)
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Run daily audit
        id: audit
        env:
          MANUS_AUDIT_API_KEY: ${{ secrets.MANUS_AUDIT_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        run: |
          echo "ðŸ” æ—¥æ¬¡ç›£æŸ»ã‚’å®Ÿè¡Œä¸­..."
          
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            "${SUPABASE_URL}/functions/v1/manus-audit-line-daily-brief" \
            -H "Authorization: Bearer ${MANUS_AUDIT_API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"type":"daily","timestamp":"'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}')
          
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ ç›£æŸ»ãŒå¤±æ•—ã—ã¾ã—ãŸ (HTTP $HTTP_CODE)"
            echo "error_type=api_error" >> $GITHUB_OUTPUT
            echo "error_message=$BODY" >> $GITHUB_OUTPUT
            echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… ç›£æŸ»ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
          echo "result=$BODY" >> $GITHUB_OUTPUT

      - name: Detect error type
        if: failure()
        id: detect_error
        run: |
          ERROR_MSG="${{ steps.audit.outputs.error_message }}"
          HTTP_CODE="${{ steps.audit.outputs.http_code }}"
          
          if echo "$ERROR_MSG" | grep -q "Missing authorization header"; then
            echo "error_type=missing_auth_header" >> $GITHUB_OUTPUT
            echo "auto_fixable=true" >> $GITHUB_OUTPUT
          elif echo "$ERROR_MSG" | grep -q "Invalid JWT"; then
            echo "error_type=invalid_jwt" >> $GITHUB_OUTPUT
            echo "auto_fixable=false" >> $GITHUB_OUTPUT
          elif echo "$ERROR_MSG" | grep -q "syntax"; then
            echo "error_type=yaml_syntax" >> $GITHUB_OUTPUT
            echo "auto_fixable=true" >> $GITHUB_OUTPUT
          else
            echo "error_type=unknown" >> $GITHUB_OUTPUT
            echo "auto_fixable=false" >> $GITHUB_OUTPUT
          fi

      - name: Auto-fix errors
        if: failure() && steps.detect_error.outputs.auto_fixable == 'true'
        id: auto_fix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ERROR_TYPE="${{ steps.detect_error.outputs.error_type }}"
          
          echo "ðŸ”§ è‡ªå‹•ä¿®æ­£ã‚’å®Ÿè¡Œä¸­: $ERROR_TYPE"
          
          case "$ERROR_TYPE" in
            missing_auth_header)
              bash scripts/auto-fix/fix-auth-headers.sh
              ;;
            yaml_syntax)
              bash scripts/auto-fix/fix-yaml-syntax.sh
              ;;
            *)
              echo "âš ï¸ è‡ªå‹•ä¿®æ­£ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              exit 1
              ;;
          esac
          
          if [ $? -eq 0 ]; then
            echo "âœ… è‡ªå‹•ä¿®æ­£ãŒå®Œäº†ã—ã¾ã—ãŸ"
            echo "fixed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ è‡ªå‹•ä¿®æ­£ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "fixed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Record to GitHub
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          LOG_DATE=$(date -u +"%Y-%m-%d")
          
          mkdir -p docs/logs/audit
          
          LOG_FILE="docs/logs/audit/daily-${LOG_DATE}.md"
          
          cat > "$LOG_FILE" <<EOF
          # Manus Audit (Daily) - ${LOG_DATE}
          
          **å®Ÿè¡Œæ™‚åˆ»**: ${TIMESTAMP}
          **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: [Run #${GITHUB_RUN_NUMBER}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})
          
          ## çµæžœ
          
          EOF
          
          if [ "${{ job.status }}" == "success" ]; then
            cat >> "$LOG_FILE" <<EOF
          âœ… **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: æˆåŠŸ
          
          **ç›£æŸ»çµæžœ**:
          \`\`\`json
          ${{ steps.audit.outputs.result }}
          \`\`\`
          EOF
          else
            cat >> "$LOG_FILE" <<EOF
          âŒ **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: å¤±æ•—
          
          **ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—**: ${{ steps.detect_error.outputs.error_type }}
          **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: ${{ steps.audit.outputs.error_message }}
          **HTTP Code**: ${{ steps.audit.outputs.http_code }}
          
          EOF
            
            if [ "${{ steps.auto_fix.outputs.fixed }}" == "true" ]; then
              cat >> "$LOG_FILE" <<EOF
          **è‡ªå‹•ä¿®æ­£**: âœ… å®Œäº†
          EOF
            else
              cat >> "$LOG_FILE" <<EOF
          **è‡ªå‹•ä¿®æ­£**: âŒ ä¸å¯
          EOF
            fi
          fi
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$LOG_FILE"
          git commit -m "chore: add daily audit log ${LOG_DATE}" || echo "No changes to commit"
          git push || echo "Failed to push"

      - name: Create GitHub Issue
        if: failure() && steps.detect_error.outputs.auto_fixable == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const errorType = '${{ steps.detect_error.outputs.error_type }}';
            const errorMessage = '${{ steps.audit.outputs.error_message }}';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            const issueTitle = `ðŸš¨ Manus Audit Failed: ${errorType}`;
            const issueBody = `## ã‚¨ãƒ©ãƒ¼è©³ç´°
            
            **ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—**: \`${errorType}\`
            **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: 
            \`\`\`
            ${errorMessage}
            \`\`\`
            
            **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ**: ${runUrl}
            
            ## å¿…è¦ãªå¯¾å¿œ
            
            ${errorType === 'invalid_jwt' ? '- Supabase API Key (`MANUS_AUDIT_API_KEY`) ã‚’æ›´æ–°ã—ã¦ãã ã•ã„' : '- æ‰‹å‹•ã§ã®ä¿®æ­£ãŒå¿…è¦ã§ã™'}
            
            ## å‚è€ƒæƒ…å ±
            
            - [MANUS_AUTOMATION.md](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/blob/main/docs/MANUS_AUTOMATION.md)
            - [RECOVERY.md](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/blob/main/RECOVERY.md)
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['bug', 'automation', 'manus-audit']
            });

      - name: Notify Discord (success)
        if: success() && vars.DISCORD_ADMIN_WEBHOOK_URL != ''
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S JST")
          RUN_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          
          curl -X POST "${{ vars.DISCORD_ADMIN_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âœ… Manus Audit (Daily) æˆåŠŸ",
                "description": "æ—¥æ¬¡ç›£æŸ»ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ",
                "color": 3066993,
                "fields": [
                  {
                    "name": "æ—¥æ™‚",
                    "value": "'"$TIMESTAMP"'",
                    "inline": true
                  },
                  {
                    "name": "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹",
                    "value": "æ­£å¸¸",
                    "inline": true
                  }
                ],
                "url": "'"$RUN_URL"'"
              }]
            }'

      - name: Notify Discord (failure)
        if: failure() && vars.DISCORD_ADMIN_WEBHOOK_URL != ''
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S JST")
          RUN_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          ERROR_TYPE="${{ steps.detect_error.outputs.error_type }}"
          AUTO_FIXED="${{ steps.auto_fix.outputs.fixed }}"
          
          if [ "$AUTO_FIXED" == "true" ]; then
            TITLE="âš ï¸ Manus Audit (Daily) å¤±æ•— â†’ è‡ªå‹•ä¿®æ­£å®Œäº†"
            DESCRIPTION="ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡ºã—ã¾ã—ãŸãŒã€è‡ªå‹•ä¿®æ­£ãŒå®Œäº†ã—ã¾ã—ãŸ"
            COLOR=16776960
          else
            TITLE="âŒ Manus Audit (Daily) å¤±æ•—"
            DESCRIPTION="ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã®å¯¾å¿œãŒå¿…è¦ã§ã™"
            COLOR=15158332
          fi
          
          curl -X POST "${{ vars.DISCORD_ADMIN_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "'"$TITLE"'",
                "description": "'"$DESCRIPTION"'",
                "color": '"$COLOR"',
                "fields": [
                  {
                    "name": "æ—¥æ™‚",
                    "value": "'"$TIMESTAMP"'",
                    "inline": true
                  },
                  {
                    "name": "ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—",
                    "value": "'"$ERROR_TYPE"'",
                    "inline": true
                  },
                  {
                    "name": "è‡ªå‹•ä¿®æ­£",
                    "value": "'"$([ "$AUTO_FIXED" == "true" ] && echo "âœ… å®Œäº†" || echo "âŒ ä¸å¯")"'",
                    "inline": true
                  }
                ],
                "url": "'"$RUN_URL"'"
              }]
            }'
