name: Node Tests
x-owner: devops

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  node-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install || echo "No dependencies to install"

      - name: Run Node tests
        run: npm test

      - name: Run action script tests
        run: npm run test:actions

      - name: Verify vendor checksums
        run: npm run vendor:verify

  actionlint:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Lint workflows with actionlint
        uses: rhysd/actionlint@v1

  act-smoke:
    if: >
      github.event_name == 'pull_request' &&
      contains(github.event.pull_request.labels.*.name, 'ci-smoke')
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm install || echo "No dependencies to install"

      - name: Install act
        run: |
          set -euo pipefail
          curl -sSL https://github.com/nektos/act/releases/download/v0.2.58/act_Linux_x86_64.tar.gz -o act.tar.gz
          sudo tar -xzf act.tar.gz -C /usr/local/bin act
          rm act.tar.gz

      - name: Run act smoke test for line-event
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: act workflow_dispatch -W .github/workflows/line-event.yml -n --container-architecture linux/amd64
