# 開発ログ: X投稿AI自動分類システム実装

**日時:** 2025年12月18日
**対象リポジトリ:** Obsidian Project Kit for Market, cursorvers_line_free_dev

---

## 概要

Discord経由でObsidianに同期されるX投稿に対し、Gemini 2.5 Flash APIを使用したAI自動分類機能を実装。LINE定期投稿の原稿として活用可能な仕組みを構築。

---

## 実装内容

### 1. Discord Sync Workflow改修

**ファイル:** `.github/workflows/discord-sync.yml` (Obsidian Project Kit for Market)

**変更点:**
- Gemini 2.5 Flash APIによるツイート内容の自動分類を追加
- `theme` (カテゴリ) と `line_worthy` (LINE投稿価値あり) のfrontmatter項目を追加
- `#cv_line` と `#[category]` タグの自動付与

**分類カテゴリ:**
| カテゴリ | 説明 |
|---------|------|
| ai_gov | 医療AI/ヘルスケアDX |
| tax | 税務・節税 |
| law | 法務・契約 |
| biz | 事業戦略・経営 |
| career | キャリア・働き方 |
| asset | 資産形成・投資 |
| tech | 開発・プログラミング |
| crypto | 暗号資産・Web3 |
| thought | 考察・意見 |
| life | 日常・雑記 |
| general | その他 |

### 2. LINE Card Export Script更新

**ファイル:** `scripts/export-line-cards/src/types.ts`, `extractor.ts` (cursorvers_line_free_dev)

**変更点:**
- 新カテゴリ (tech, crypto, thought, life) を `CardTheme` 型に追加
- `THEME_TAG_MAP` に新タグのマッピングを追加
- `cleanCardBody()` 関数で新タグの除去処理を追加

### 3. 画像のみファイルのクリーンアップ

**作業:** 49件の問題ファイルを削除

ツイート本文が取得できず、画像URLのみが記録されていた既存ファイルを一括削除。

---

## 修正したエラー

### 1. YAML構文エラー (heredoc内)

**原因:**
```yaml
カテゴリ:
- ai_gov: 医療AI/ヘルスケアDX  # ← YAMLとして解釈される
```

**修正:**
プロンプトを単一行形式に変更し、適切なインデントを設定。

### 2. workflow_dispatch トリガー不認識

**原因:**
```yaml
workflow_dispatch:  # inputs なしだとエラー
```

**修正:**
```yaml
workflow_dispatch:
  inputs: {}
```

### 3. Git push 拒否

**原因:** リモートに先行コミットが存在

**修正:**
```bash
git stash push && git pull origin main --rebase && git stash pop && git push
```

---

## GitHub Secrets設定

### Obsidian Project Kit for Market
| シークレット | 設定日 |
|-------------|--------|
| DISCORD_BOT_TOKEN | 2025-12-18 |
| GEMINI_API_KEY | 2025-12-18 (新規追加) |

### cursorvers_line_free_dev
既存のシークレット (SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY 等) は変更なし。

---

## データフロー

```
X投稿
   ↓
TweetShift (Discord Bot)
   ↓
Discord Channel (#1444566050711801957)
   ↓
[discord-sync.yml] 毎日 00:00 JST
   ↓
Gemini 2.5 Flash API (分類)
   ↓
Obsidian Vault (04_Journals/X-clip/*.md)
   - frontmatter: theme, line_worthy
   - tags: #cv_line, #[category]
   ↓
[sync-line-cards.yml] 毎日 06:00 JST
   ↓
Supabase (line_cards テーブル)
   ↓
[line-daily-brief-cron.yml] 毎日 07:00 JST
   ↓
LINE配信
```

---

## 検証結果

| ワークフロー | ステータス | 最終実行 |
|------------|----------|---------|
| discord-sync.yml | ✅ 成功 | 2025-12-18 05:34 |
| sync-line-cards.yml | ✅ 成功 | 2025-12-17 21:20 |
| stats-exporter-cron.yml | ✅ 成功 | 2025-12-18 03:56 |

---

## Git コミット履歴

```
07dfc0d Add more category tags: tech, crypto, thought, life
985f841 Fix YAML syntax error in heredoc prompt
870d9b8 Fix workflow_dispatch trigger
3a57200 Update to Gemini 2.5 Flash (latest preview)
4107e41 Switch AI classification to Gemini 2.0 Flash
4e03f30 Switch AI classification from Anthropic to OpenAI API
6451fe2 Add AI-based auto-labeling for X posts to LINE cards
a3d5ea3 Improve discord-sync workflow and cleanup image-only X-clip files
```

---

## 今後の課題

1. **分類精度の検証** - 実際のX投稿での分類結果をモニタリング
2. **LINE配信テスト** - AI分類されたコンテンツがLINE配信に正しく反映されるか確認
3. **Google Sheets連携** - stats-exporter経由でのレポート出力確認

---

**作成者:** Claude Code
**作成日時:** 2025年12月18日
